<!DOCTYPE html>
<html lang="en">

    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><title>Two Factor Authentication for GMail and (Neo)Mutt &ndash; Matthew R. Hennefarth</title>
<meta name="description" content="Ph.D. Candidate in Chemistry at UChicago">

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="UTF-8"/>



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin="anonymous" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css" integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin="anonymous" />


<link rel="stylesheet" href="http://localhost:1313/css/palettes/base16-dark.css">
<link rel="stylesheet" href="http://localhost:1313/css/risotto.css">
<link rel="stylesheet" href="http://localhost:1313/css/custom.css">




</head>

    <body>
        <div class="page">

            <header class="page__header"><nav class="page__nav main-nav">
    <ul>
    <h1 class="page__logo"><a href="http://localhost:1313/" class="page__logo-inner">Matthew R. Hennefarth</a></h1>
    
    
    <li class="main-nav__item"><a class="nav-main-item" href="http://localhost:1313/notes/" title="">Notes</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item" href="http://localhost:1313/projects/" title="">Projects</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item" href="http://localhost:1313/publications/" title="">Publications</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item" href="http://localhost:1313/research/" title="">Research</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item" href="http://localhost:1313/teaching/" title="">Teaching</a></li>
    
    </ul>
</nav>

</header>

            <section class="page__body">
    <header class="content__header">
        <h1>Two Factor Authentication for GMail and (Neo)Mutt</h1>
    </header>
    <div class="content__body">
      <br><p>We will deal with adding an email account that requires 2FA for gmail to
neomutt. Firstly, we need to get a client id and client secret using Google
Cloud. Make sure that we register the desktop version! Make sure to then
authorize the emails that you want with this application and that you allow less
secure applications for each of the email accounts.</p>
<h2 id="generating-2fa-tokens">Generating 2FA Tokens</h2>
<p>Next, we need the following script: <a href="https://github.com/muttmua/mutt/blob/master/contrib/mutt_oauth2.py" target="_blank" rel="nofollow noopener noreferrer">mutt_oauth2.py</a>. We need to fill in the client id and client secret in this file with that from Google. Additionally, replace the <code>YOUR_GPG_IDENTITY</code> in the <code>ENCRPYTION</code> with the correct GPG id to use. Place this script in <code>~/.local/bin</code>. Next we can call it as</p>
<pre tabindex="0"><code>mutt_oauth2.py &lt;email&gt;.tokens --verbose --authorize
</code></pre><p>I then recommend using <code>authcode</code> but you may have to try all of the various
authorizations. Once this finishes, then there should be a file
<code>&lt;email&gt;.tokens</code>. I recommend placing this into the <code>~/.local/bin</code> directory
(though it probably belongs in the <code>.cache</code> or <code>.config</code> directory).</p>
<h2 id="setting-the-config-files">Setting the Config Files</h2>
<p>We are now ready to just setup the <code>.mbsyncrc</code>
and <code>msmtp/config</code> files. For the <code>.mbsyncrc</code> file, we need to add the following
lines, replacing <code>&lt;email&gt;</code> with the email address of course:</p>
<pre tabindex="0"><code>IMAPStore &lt;email&gt;-remote
Host imap.gmail.com
Port 993
User &lt;email&gt;
PassCmd &#34;mutt_oauth2.py ~/.local/bin/&lt;email&gt;tokens&#34;
AuthMechs XOAUTH2
SSLType IMAPS
CertificateFile /etc/ssl/cert.pem

MaildirStore &lt;email&gt;-local
Subfolders Verbatim
Path ~/.local/share/mail/&lt;email&gt;/
Inbox ~/.local/share/mail/&lt;email&gt;/INBOX

Channel &lt;email&gt;
Expunge Both
Far :&lt;email&gt;-remote:
Near :&lt;email&gt;-local:
Patterns * !&#34;[Gmail]/All Mail&#34;
Create Both
SyncState *
MaxMessages 0
ExpireUnread no
# End profile
</code></pre><p>We can now update the <code>.config/msmtp/config</code> file similarly as</p>
<pre tabindex="0"><code>account &lt;email&gt;
host smtp.gmail.com
port 465
from &lt;email&gt;
user &lt;email&gt;
passwordeval &#34;mutt_oauth2.py ~/.local/bin/&lt;email&gt;.tokens&#34;
auth oauthbearer
tls on
tls_trust_file	/etc/ssl/cert.pem
logfile ~/.cache/msmtp/msmtp.log
tls_starttls off
</code></pre><p>Make sure to then create the mail directory as</p>
<pre tabindex="0"><code>mkdir ~/.local/share/mail/&lt;email&gt;
</code></pre><p>We can now run <code>mbsync &lt;email&gt;</code>!</p>
<h2 id="error-performing-sasl-authentication-step">Error Performing SASL Authentication Step</h2>
<p>If you are on MacOS, you likely will get an error of</p>
<pre tabindex="0"><code>Error performing SASL authentication step: SASL(-1): generic failure: Unable to find a callback: 18948
</code></pre><p>This has to do with an issue of the <a href="https://github.com/moriyoshi/cyrus-sasl-xoauth2/issues/9#issuecomment-888149239" target="_blank" rel="nofollow noopener noreferrer">OS X SASL setup</a>. To circumvent this, we need to modify the default <code>isync</code> that comes with Homebrew. To do this, we can do the following:</p>
<pre tabindex="0"><code>brew edit isync
</code></pre><p>Now, replace the <code>HEAD</code> with <code>https://github.com/xukai92/isync.git</code>. Then, we
need to remove all lines starting with <code>url</code> and <code>sha256</code>. Then, we run the
following command</p>
<pre tabindex="0"><code>HOMEBREW_NO_INSTALL_FROM_API=1 brew reinstall isync --build
</code></pre><p>Unfortunately, doing this will cause <code>openssl$3--3.0.7</code> to be the default
version of <code>openssl</code> (or some lower version in general), which can cause issues with ssh and git. To get around
this, we just need to unlink and link:</p>
<pre tabindex="0"><code>brew unlink openssl@3
brew link openssl@3
</code></pre><p>Now, everything should be good!</p>

    </div>
    <footer class="content__footer"></footer>

            </section>

            <section class="page__aside">
                <div class="aside__about">
<div class="aside__about">
    
<h1 class="about__title">Matthew R. Hennefarth</h1>
<p class="about__description">Ph.D. Candidate in Chemistry at UChicago</p>
</div>


<ul class="aside__social-links">
    
    <li>
        <a href="https://github.com/matthew-hennefarth" rel="me" aria-label="GitHub" title="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="https://twitter.com/m_hennefarth" rel="me" aria-label="Twitter" title="Twitter"><i class="fa-brands fa-twitter" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="https://orcid.org/0000-0002-6601-2253" rel="me" aria-label="ORCID" title="ORCID"><i class="ai ai-orcid" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="https://scholar.google.com/citations?user=Sds3I_QAAAAJ&amp;hl=en&amp;oi=ao" rel="me" aria-label="Google Scholar" title="Google Scholar"><i class="ai ai-google-scholar" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="/cv.pdf" rel="me" aria-label="CV" title="CV"><i class="ai ai-cv" aria-hidden="true"></i></a>&nbsp;
    </li>
    
</ul>
</div>
                <hr>
                <div class="aside__content">
    
    
        <p>
            By Matthew R. Hennefarth, 
            2023-08-03
        </p>
    

                </div>
            </section>

            <footer class="page__footer">
<center>
    <p class="copyright">Â© 2023 Matthew R. Hennefarth</p>
</center>
</footer>

        </div>
    </body>

</html>
